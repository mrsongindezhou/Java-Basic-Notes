## MQ的消息堆积问题
主要原因：一般是客户端本地消费过程中，由于消费耗时过长或消费并发度较小等原因，导致客户端消费能力不足，出现消息堆积的问题

### 如何避免消息堆积和延迟
1. 梳理消息的消费耗时
- 通过压测获取消息的消费耗时，并对耗时较高的操作的代码逻辑进行分析。查询消费耗时，请参见获取消息消费耗时。梳理消息的消费耗时需要关注以下信息：
    - **计算情况**： 消息消费逻辑的计算复杂度是否过高，代码是否存在无限循环和递归等缺陷。
    - **IO情况**： 消息消费逻辑中的I/O操作（如：外部调用、读写存储等）是否是必须的，能否用本地缓存等方案规避。
    - **异步化**：
    消费逻辑中的复杂耗时的操作是否可以做异步化处理，如果可以是否会造成逻辑错乱（消费完成但异步操作未完成）。
2. 设置消息的消费并发度
- 压测线程数：逐步调大线程的单个节点的线程数，并关测节点的系统指标，得到单个节点最优的消费线程数和消息吞吐量。
- 压测节点数：得到单个节点的最优线程数和消息吞吐量后，根据上下游链路的流量峰值计算出需要设置的节点数，节点数=流量峰值/单线程消息吞吐量。

3. 设置监控报警
想要快速避免消息堆积和延迟给业务带来的影响，您可以通过消息队列MQ版提供的监控报警功能，设置告警规则提前预警消息堆积问题，或通过业务埋点，触发报警事件，及时监控到消息堆积问题并进行处理。

### MQ消息堆积的解决方案
1. 若出现消息堆积，可参考以下措施进行定位和处理。

根据日志判断消息堆积在消息队列RocketMQ版服务端还是客户端。

```
the cached message count exceeds the threshold
```

- 出现相关日志信息，说明客户端本地缓冲队列已满，消息堆积在客户端，请执行步骤2。
- 若未出现相关日志，说明消息堆积不在客户端，若出现这种情况，需要排查服务端问题。

2. 确认消息的消费耗时是否合理。
- 若查看到消费耗时较长，则需要查看客户端堆栈信息排查具体业务逻辑，请执行步骤3。
- 若查看到消费耗时正常，则有可能是因为消费并发度不够导致消息堆积，需要逐步调大消费线程或扩容节点来解决。

3. 查看客户端堆栈信息。
- 使用Jstack工具打印堆栈信息。
- 使用可视化工具查看MQ消费状态。

异常堆栈情况如下：
示例一：空闲无堆积的堆栈。
消费空闲情况下消费线程都会处于WAITING状态等待从消费任务队里中获取消息。

示例二：消费逻辑有抢锁休眠等待等情况。
消费线程阻塞在内部的一个睡眠等待上，导致消费缓慢。

示例三：消费逻辑操作数据库等外部存储卡住。
消费线程阻塞在外部的HTTP调用上，导致消费缓慢。


4. 针对某些特殊业务场景，如果消息堆积已经影响到业务运行，且堆积的消息本身可以丢弃，您可以通过重置消费位点跳过这些堆积的消息做到快速恢复。重置过程需要保证消费者客户端在线。