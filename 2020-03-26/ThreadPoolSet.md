## 高并发情景下，核心线程池该如何设置参数？
线程数设置多少合适
创建多少线程合适，要看多线程具体的应用场景。I/O 密集型程序和 CPU密集型程序，计算最佳线程数的方法是不同的。

1. CPU 密集型计算:
- 多线程本质上是提升多核 CPU 的利用率，所以对于一个 4 核的 CPU，每个核一个线程，理论上创建 4 个线程就可以了，再多创建线程也只是增加线程切换的成本。
- 理论上“线程的数量 = CPU 核数”就是最合适的。
- 不过在工程上，线程的数量一般会设置为“CPU 核数 +1”，这样的话，当线程因为偶尔的内存页失效或其他原因导致阻塞时，这个额外的线程可以顶上，从而保证 CPU 的利用率。
2. I/O 密集型的计算场景

- 对于单个CPU可以总结出这样一个公式：最佳线程数 =1 +（I/O 耗时 / CPU 耗时）
- 对于多核 CPU，需要等比扩大，计算公式如下：最佳线程数 =CPU 核数 * [ 1 +（I/O 耗时 / CPU 耗时）]
3. 实际应用：
- 在不同的业务场景以及不同配置的部署机器中，线程池的线程数量设置是不一样的。
- 其设置不宜过大，也不宜过小，要根据具体情况，计算出一个大概的数值，再通过实际的性能测试，计算出一个合理的线程数量。
- 保证 CPU 处理线程的最大化
- **设置核心线程数的时候，同时设置最大线程数即可。其实可以把二者设置为相同的值**

### 禁止使用Executors方法的原因
- 禁止使用Executors方来创建线程池，而应该手动 new ThreadPoolExecutor 来创建线程池。
- 最重要的原因是：Executors 提供的很多方法默认使用的都是**无界的** LinkedBlockingQueue，高负载情境下，无界队列很容易导致 **OOM**，而 OOM 会导致所有请求都无法处理，这是致命问题。
- 最典型的就是 newFixedThreadPool 和 newCachedThreadPool，可能因为资源耗尽导致 OOM 问题。